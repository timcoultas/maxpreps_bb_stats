# Colorado High School Baseball Projection System

## Introduction

This project answers a simple question every coach, player, and fan asks in the offseason: **_"What's going to happen next year?"_**

We built a complete projection pipeline that takes historical player statistics from MaxPreps (2022-2025), applies development curves to returning players, fills roster gaps with realistic replacement-level talent, simulates an entire season's worth of games, and produces power rankings for 37 (and growing) Colorado 5A teams.

The system was designed for Colorado 5A baseball, specifically to project Rocky Mountain High School's 2026 season. However, the approach is portable to any high school program with sufficient historical data.

**What this is:** A data-driven scouting report generator. It tells you which returning juniors are poised for breakout seasons, which roster spots need reinforcements, which teams are filled with veterans, which are rebuilding, and which games on the schedule are likely wins, toss-ups, or uphill battles.

**What this is not:** A crystal ball. Baseball is chaotic. A 70% win probability means you lose 3 out of 10 times. The value here is in setting realistic expectations and identifying where your team's strengths and weaknesses lie before the first pitch of spring.

---

## Outputs

Process produces four **key** deliverables:

### Projected Rosters 
Complete roster projections for every team in the dataset. Each returning player has their stats projected forward using development multipliers. Batting and Pitching rankings are developed for each player. Roster gaps are filled with tiered generic players. 

### Team Power Rankings
Every team is given a Overall Power score and ranked. The Overall Power score is based on a combination of the team's Offensive and Pitching Power scores, which are based on projected player performance. The Team Power Rankings also tell you the number of returning team members, returning seniors, and years of varisity experience on the team. 

### Regular Season Simulation
Game-by-game win probabilities generated by running 1,000 Monte Carlo simulations per matchup. Includes projected scores, confidence labels ("Lock", "Solid", "Toss-up"), and a season summary with floor/ceiling win totals. These are based on team Power Ranking matchups and not more advanced Markov Chain analyses. 

**Sample Output:**
```
Date         Opponent                       Win %    Avg Score    Confidence      Analysis
03/15        Fossil Ridge                   62.3%    6.2-5.1      Solid (W)       Edge: Better Bats, Home Field
03/18        Cherry Creek                   38.1%    4.8-5.9      Toss-up         Opponent advantage: Their Pitching
...

SEASON PROJECTION (1000 Sims):
Average Record: 14.2 - 8.8
Ceiling (90th %): 18 Wins
Floor (10th %):   10 Wins
```

### Historical Player Statistics
Four years of player season statistics across 37 (and counting) Colorado 5A teams. This information contains player level season data sourced from MaxPreps and aggregates it into one file. 


---

## Methodology

### The Sabermetrics Foundation

This system stands on the shoulders of established baseball analytics research. Every calculation is traceable to published methodology.

**Player Valuation — Runs Created (RC)**

We measure offensive contribution using Bill James' Runs Created formula, first published in the 1979 Baseball Abstract:

```
RC = (H + BB) × TB / (AB + BB)
```

Where TB (Total Bases) = 1B + (2 × 2B) + (3 × 3B) + (4 × HR). This formula correlates with actual team runs scored at r > 0.95 across MLB seasons. While more sophisticated versions exist (wOBA, wRC+), the basic formula is appropriate for high school data where sample sizes are smaller and advanced inputs are often unavailable.

**Player Valuation — Pitching Dominance Score**

Pitchers are evaluated using a simplified adaptation of Bill James' Game Score metric:

```
Pitching_Score = (IP × 1.5) + (K × 1.0) - (BB × 1.0) - (ER × 2.0)
```

This weights innings (durability) and strikeouts (dominance) positively while penalizing walks and earned runs. It's less granular than FIP (Fielding Independent Pitching) but appropriate for high school where defensive quality varies significantly and batted ball data is unavailable.

**Development Curves — Aging Methodology**

Player projections use year-over-year multipliers derived from historical cohort analysis. We calculate the median ratio of Year N+1 stats to Year N stats for each class transition (Freshman→Sophomore, etc.).

The multiplier hierarchy prioritizes:
1. **Class (Age-Based):** Largest sample sizes, most representative population
2. **Class + Tenure (Specific):** Higher specificity when available  
3. **Tenure Only:** Fallback, but prone to survivor bias

This ordering follows guidance from Tango, Lichtman, and Dolphin (*The Book*, 2006) on aging curve methodology.

**Replacement Level — Generic Players**

Roster backfill uses percentile-based profiles rather than mean imputation. This preserves population variance and aligns with the "Replacement Level" concept in WAR calculations—roughly the 20th-30th percentile of available talent. Elite programs (based on historical state rankings) receive 50th percentile replacements; other programs receive 30th percentile.

**Game Simulation — Negative Binomial Distribution**

Game scores are simulated using the Negative Binomial distribution rather than Poisson. Baseball scoring exhibits "over-dispersion" (variance exceeds mean) because runs come in bunches during big innings. Empirical analysis of this dataset shows a variance/mean ratio of ~13.4, far exceeding the Poisson assumption of Var=Mean. The Negative Binomial's dispersion parameter (set to 1.3) models this clumpiness.

Reference: Lindsey, G.R. "An Investigation of Strategies in Baseball." *Operations Research* 11.4 (1963): 477-501.

**Run Expectancy — Pythagorean Dampening**

Team strength indices are dampened using square root transformation before calculating expected runs. This derives from Pythagorean Expectation principles (Bill James, 1980) and prevents unrealistic projections when elite offenses face weak pitching.

```
Expected_Runs = League_Base × √(Off_Index) × (1 / √(Opp_Pit_Index))
```

---

### Technical Architecture

The pipeline is structured as a sequential DAG (Directed Acyclic Graph) with clear data dependencies.

```
┌─────────────────────────────────────────────────────────────────────┐
│                         DATA LAYER                                   │
├─────────────────────────────────────────────────────────────────────┤
│  data/raw/{team}/{period}/*.html    ← MaxPreps scraped pages        │
│  data/processed/{period}/           ← Cleaned CSVs                  │
│  data/input/                        ← Schedule files                │
│  data/output/                       ← Final deliverables            │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      ETL LAYER (src/etl/)                           │
├─────────────────────────────────────────────────────────────────────┤
│  metadata.py        → Extracts team/season from HTML utag_data      │
│  stat_extraction.py → Parses player stats using STAT_SCHEMA map     │
│  class_inference.py → Imputes missing class years via backfill      │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  ANALYTICS LAYER (src/workflows/)                   │
├─────────────────────────────────────────────────────────────────────┤
│  Step 1: development_multipliers.py                                 │
│          └─ Calculates YoY ratios from historical cohorts           │
│                                                                     │
│  Step 2: profile_generator.py                                       │
│          └─ Creates percentile-based generic player profiles        │
│                                                                     │
│  Step 3: roster_prediction.py                                       │
│          └─ Projects returning players + backfills rosters          │
│                                                                     │
│  Step 4: team_strength_analysis.py                                  │
│          └─ Aggregates to team-level power rankings                 │
│                                                                     │
│  Step 5: game_simulator.py                                          │
│          └─ Monte Carlo simulation of season schedule               │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    MODELS LAYER (src/models/)                       │
├─────────────────────────────────────────────────────────────────────┤
│  advanced_ranking.py → RC Score + Pitching Score calculations       │
│                        Applied as Window Functions (RANK OVER)      │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    CONFIG LAYER (src/utils/)                        │
├─────────────────────────────────────────────────────────────────────┤
│  config.py → STAT_SCHEMA (column mappings), PATHS, ELITE_TEAMS      │
│  utils.py  → Identity resolution, Varsity_Year calculation          │
└─────────────────────────────────────────────────────────────────────┘
```

**Key Technical Patterns:**

| Concept | Python Implementation | SQL Equivalent |
|---------|----------------------|----------------|
| Filtering players | `df[df['PA'] > 10]` | `WHERE PA > 10` |
| Percentile ranking | `df['col'].rank(pct=True)` | `PERCENT_RANK() OVER (ORDER BY col)` |
| Team-level aggregation | `df.groupby('Team').agg(...)` | `GROUP BY Team` |
| Multiplier lookup | `df_multipliers.loc[transition]` | `JOIN multipliers ON transition` |
| Top-N selection | `df.nlargest(9, 'RC_Score')` | `SELECT TOP 9 ... ORDER BY RC_Score DESC` |
| Null handling | `df['col'].fillna(0)` | `COALESCE(col, 0)` |

---

## Pipeline Execution

### Prerequisites

```bash
# Python 3.8+
pip install pandas numpy beautifulsoup4 lxml
```

### Directory Structure

```
maxpreps_bb_stats/
├── data/
│   ├── raw/                    # HTML files from MaxPreps
│   │   ├── {team_name}/
│   │   │   ├── history/        # Historical seasons (2022-2024)
│   │   │   └── 2025/           # Current season
│   ├── processed/              # Cleaned CSVs (auto-generated)
│   ├── input/                  # Schedule files
│   │   └── rocky_mountain_schedule.csv
│   └── output/                 # Final outputs (auto-generated)
├── src/
│   ├── etl/
│   ├── models/
│   ├── utils/
│   └── workflows/
└── run_pipeline.py
```

### Running the Pipeline

**Full execution (ETL + Analytics):**
```bash
python run_pipeline.py --period history --teams all
```

**ETL only (skip projections):**
```bash
python run_pipeline.py --period 2025 --teams all --skip-analysis
```

**Single team:**
```bash
python run_pipeline.py --period history --teams "Rocky Mountain"
```

### Pipeline Arguments

| Argument | Description | Example |
|----------|-------------|---------|
| `--period` | Target subfolder in raw data | `history`, `2025` |
| `--teams` | Teams to process (or `all`) | `"Rocky Mountain" "Fossil Ridge"` |
| `--skip-analysis` | Run ETL only, skip projections | Flag, no value |

### Expected Console Output

```
--- PHASE 1: ETL EXECUTION (history) ---
Scanning: Rocky Mountain/history...
   -> Running Class Inference...
   -> Saved: data/processed/Rocky Mountain/history/Rocky Mountain_history_stats.csv (847 records)
...
--- Aggregation Complete ---

==================================================
STARTING ANALYTICS CHAIN
==================================================

--- Step 1: Updating Development Models ---
Found 1,247 year-over-year player transitions.
Saved multipliers to 'data/output/development_multipliers/development_multipliers.csv'

--- Step 2: Generating Replacement Profiles ---
Success. Saved 10 generic profiles.

--- Step 3: Predicting 2026 Rosters ---
[Pipeline Log] Returning players: 420
[Pipeline Log] Backfilling 193 generic player slots.
Success! Generated projected roster with 613 players.

--- Step 4: Analyzing Team Strength ---
=== 2026 PROJECTED TEAM POWER RANKINGS ===
...

--- Step 5: Game Simulator ---
Date         Opponent                       Win %    Avg Score    ...
...
SEASON PROJECTION (1000 Sims):
Average Record: 14.2 - 8.8
```

---

## Data Acquisition

### Obtaining Data from MaxPreps

Each highschool baseball team has a page on the MaxPreps website. This information is accurate (particularly for varsity) as it is what CHSAA uses to generate their state rankings. These pages contain detailed season and player level statistics. 

However, because of the way that the MaxPreps website is structured, these statistics are difficult to scrape in an automated way. (Another project!)

In order to obtain this information, I've followed the following steps. 

From the main baseball page of the school, (eg: https://www.maxpreps.com/co/fort-collins/rocky-mountain-lobos/baseball/)

Navigate to the appropriate season. 

Click "Stats" in the upper navigation bar. 

Click "Player Stats" in the lower navigation bar. 

Scroll down past the second "Batting" table. 

Right-Click "Print" and select open in seprate tab or new window.

The page will open and subsequently a print diaglog box will open. Close the print dialog box by selecting "Cancel." 

On the new stats page that is now open, select "Save As" from the page menu.

Save as "Webpage, HTML Only" (this is in Google Chrome) as opposed to "Complete Page". 

Saved that file, named something like "rocky_22" in the target directory. 

This is the file the ETL ingestion process will read. 

Repeat for as many teams and years as you want. 

---

## Configuration

### Adding Teams to ELITE_TEAMS

Edit `src/utils/config.py` to modify which programs receive 50th percentile backfill:

```python
ELITE_TEAMS = [
    "Cherry Creek (Greenwood Village, CO)",
    "Regis Jesuit (Aurora, CO)",
    "Rocky Mountain (Fort Collins, CO)",
    # Add teams with consistent state tournament appearances
]
```

### Modifying Stat Schema

The `STAT_SCHEMA` in `config.py` maps MaxPreps HTML classes to internal column names. If MaxPreps changes their markup, update the `max_preps_class` values:

```python
STAT_SCHEMA = [
    {"abbreviation": "H", "max_preps_class": "hits stat dw", "stat_type": "Batting"},
    # ...
]
```

---

## Limitations & Future Work

**Current Limitations:**
- No park effects (all fields treated equally)
- No strength-of-schedule adjustment in power rankings
- Dispersion parameter (1.3) not calibrated to actual HS game data
- No pitcher matchup modeling (uses aggregate staff strength)

**Potential Enhancements:**
- Backtest against historical game results
- Add field dimension adjustments for altitude/fence distances
- Implement Bayesian regression for small-sample players
- Add confidence intervals to projections (currently point estimates only)

See `docs/FUTURE_OPPORTUNITIES.md` for detailed implementation notes.

---

## References

- James, Bill. *The Bill James Baseball Abstract* (1979-1988). Self-published.
- Tango, Tom, Mitchel Lichtman, and Andrew Dolphin. *The Book: Playing the Percentages in Baseball*. Potomac Books, 2006.
- Lindsey, G.R. "An Investigation of Strategies in Baseball." *Operations Research* 11.4 (1963): 477-501.
- Cameron, Dave. "The Beginner's Guide to Replacement Level." FanGraphs, 2010.

---

## License

This project is for educational and personal use. MaxPreps data is subject to their Terms of Service.
